define("eventemiter,audio,storage,particle,dron,player".split(","),function(e,f,i,j,g,h){return Game=e.extend({init:function(a){this._super();var b=this;this.createCanvas();this.initFpsCounter();this.app=a;this.score=0;this.particles=[];this.audio=new f;this.running=this.enabled=!1;this.player=new h(this.canvasWidth,this.canvasHeight);this.audio.on("music:ready",function(a,d){b.audio.isMusicPlay()||b.audio.playMusic(d)});this.createParticles();this.tick()},setStorage:function(a){this.storage=a},initFpsCounter:function(){var a=
this;this.fps=this.fpsCounter=0;setInterval(function(){a.fps=a.fpsCounter;a.fpsCounter=0;a.trigger("fps:update",[a.fps])},1E3)},restart:function(){this.canvas.className="running";this.score=0;this.running=!0;_.invoke(this.particles,"respawn");this.player.play();this.audio.playMusic("Lee_Rosevere_-_03_-_Plateau");document.getElementById("score").innerHTML="Score: <i>"+this.score+"</i>"},stop:function(){var a=document.getElementById("legend"),b=document.getElementById("result");a.className="legend";
this.running=!1;this.canvas.className="";a.className=this.player.isDead()?"legend dead":"legend win";this.storage.setMaxScore(this.score);b.innerHTML="You score is "+this.score+". Max score is "+this.storage.getMaxScore()},renderQueue:function(a){a=_.bind(a,this);window.requestAnimationFrame?setTimeout(function(){requestAnimationFrame(a)},REFRESH_INNTERVAL):setTimeout(a,REFRESH_INNTERVAL)},createCanvas:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=window.innerWidth;
a.height=window.innerHeight;document.body.appendChild(a);this.ctx=b;this.canvas=a;this.canvasWidth=window.innerWidth;this.canvasHeight=window.innerHeight},createParticles:function(){var a=this,b=null;_.times(PARTICLE_COUNT,function(){b=new g(a.canvas.width,a.canvas.height);a.particles.push(b)});this.canvas.addEventListener("mousemove",function(b){var d=b.clientX,b=b.clientY;a.running&&a.player.moveTo(d,b)});this.canvas.addEventListener("touchmove",function(b){if(1==b.touches.length){var d=b.touches[0],
b=d.pageX,d=d.pageY;a.running&&a.player.moveTo(b,d)}})},tick:function(){_.invoke(this.particles,"tick");this.running&&(this.player.tick(),this.checkCollision());this.render();this.renderQueue(this.tick)},render:function(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight);_.invoke(this.particles,"draw",this.ctx);this.running&&this.player.draw(this.ctx);this.fpsCounter++},checkCollision:function(){var a=this,b=a.player;_.each(this.particles,function(c){b.isCollision(c)&&(c.radius>b.radius?
(a.audio.playSound("big_bomb"),b.die(),a.stop()):(a.audio.playSound("achievement"),b.radius+=c.radius/10,a.score+=Math.ceil(c.radius/10),a.trigger("score:update",[a.score]),c.respawn(),100<b.radius&&(b.stop(),a.stop())))})},resize:function(a,b){this.canvasWidth=a;this.canvasHeight=b;this.canvas.width=a;this.canvas.height=b;_.each(this.particles,function(c){c.maxWidth=a;c.maxHeight=b});this.player.maxWidth=a;this.player.maxHeight=b}})});